<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>SH+H Shashka</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f7f7f7;
    }
    h1 {
      color: #333;
      margin-top: 10px;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 60px);
      gap: 2px;
      margin: 20px auto;
      user-select: none;
    }
    .cell {
      width: 60px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .white {
      background: #eee;
    }
    .black {
      background: #555;
    }
    .piece {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
    }
    .oq {
      background: white;
      border: 2px solid #aaa;
    }
    .qora {
      background: black;
      border: 2px solid #000;
    }
    #status {
      font-weight: bold;
      margin-top: 10px;
      color: #333;
    }
    #shh {
      position: fixed;
      bottom: 10px;
      right: 15px;
      font-weight: bold;
      color: #999;
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <h1>♟ SH+H Shashka ♟</h1>

  <input id="room" placeholder="Xona nomi" />
  <button id="join">Xonaga kirish</button>

  <div id="status"></div>
  <div id="board"></div>
  <div id="shh">SH+H</div>

  <script>
    let socket;
    let playerColor = null;
    let turn = "oq"; // oq birinchi yuradi
    let selectedPiece = null;
    let cells = [];

    const board = document.getElementById("board");

    function createBoard(flip = false) {
      board.innerHTML = "";
      cells = [];

      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          const cell = document.createElement("div");
          cell.classList.add("cell", (r + c) % 2 === 0 ? "white" : "black");
          if ((r + c) % 2 !== 0) {
            if (r < 3) {
              const p = document.createElement("div");
              p.classList.add("piece", "qora");
              cell.appendChild(p);
            } else if (r > 4) {
              const p = document.createElement("div");
              p.classList.add("piece", "oq");
              cell.appendChild(p);
            }
          }
          cells.push(cell);
          board.appendChild(cell);
        }
      }

      if (flip) board.style.transform = "rotate(180deg)";
    }

    function getCell(row, col) {
      return cells[row * 8 + col];
    }

    function handleCellClick(e) {
      const cell = e.currentTarget;
      const piece = cell.querySelector(".piece");

      if (piece && piece.classList.contains(playerColor)) {
        selectedPiece = cell;
        cell.style.outline = "2px solid yellow";
      } else if (selectedPiece) {
        const fromIndex = Array.from(board.children).indexOf(selectedPiece);
        const toIndex = Array.from(board.children).indexOf(cell);

        const movingPiece = selectedPiece.querySelector(".piece");
        if (!movingPiece) return;

        // faqat qora katakka yuradi
        if (!cell.classList.contains("black")) return;

        selectedPiece.style.outline = "none";
        selectedPiece.innerHTML = "";
        cell.appendChild(movingPiece);
        selectedPiece = null;

        // navbatni almashtirish
        turn = turn === "oq" ? "qora" : "oq";
        updateStatus();

        // yurishni serverga yuborish
        socket.send(JSON.stringify({ type: "move", from: fromIndex, to: toIndex }));
      }
    }

    function updateStatus() {
      const status = document.getElementById("status");
      if (turn === playerColor) {
        status.textContent = "Sizning navbatingiz!";
      } else {
        status.textContent = "Raqib yurmoqda...";
      }
    }

    document.getElementById("join").onclick = () => {
      const room = document.getElementById("room").value.trim();
      if (!room) return alert("Xona nomini kiriting!");

      socket = new WebSocket("wss://shashka-server.onrender.com");

      socket.onopen = () => {
        socket.send(JSON.stringify({ type: "join", room }));
        document.getElementById("status").textContent = `${room} xonasiga ulanildi...`;
      };

      socket.onmessage = (e) => {
        const data = JSON.parse(e.data);

        if (data.type === "start") {
          playerColor = data.player;
          const flip = playerColor === "qora";
          createBoard(flip);

          document.querySelectorAll(".cell").forEach((c) => {
            c.addEventListener("click", handleCellClick);
          });

          document.getElementById("status").textContent = `${data.msg} Siz ${playerColor.toUpperCase()} toshsiz.`;
          updateStatus();
        }

        if (data.type === "move") {
          const fromCell = board.children[data.from];
          const toCell = board.children[data.to];
          const piece = fromCell.querySelector(".piece");
          if (piece) {
            fromCell.innerHTML = "";
            toCell.appendChild(piece);
            turn = turn === "oq" ? "qora" : "oq";
            updateStatus();
          }
        }
      };
    };
  </script>
</body>
</html>
